name: CI Pipeline

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOTNET_VERSION: '9.0.x'  
  SOLUTION_FILE:  'Desktop/CoreX-Fitness-Backend-Feature-Ratelimiting/CoreX.sln'
jobs:
  pre-flight-checks:
    name: Pre-Flight Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with: 
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name:  Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name:  Verify dependency integrity
        run: dotnet list package --vulnerable --include-transitive

      - name: Check for outdated packages
        run: dotnet list package --outdated
        continue-on-error: true  # Don't fail, just report

  code-formatting:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet format tool
        run: dotnet tool install -g dotnet-format

      - name: Check code formatting
        run: dotnet format ${{ env.SOLUTION_FILE }} --verify-no-changes --verbosity diagnostic

  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name:  Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build with code analysis
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore /p:TreatWarningsAsErrors=true /p:EnableNETAnalyzers=true /p:AnalysisMode=AllEnabledByDefault

      - name: Run Roslyn Analyzers
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore /p:RunAnalyzersDuringBuild=true

  security-scanning:
    name:  Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env. DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Scan for vulnerable dependencies
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerable-dependencies.txt
          if grep -q "has the following vulnerable packages" vulnerable-dependencies.txt; then
            echo "Vulnerable dependencies found!"
            exit 1
          fi

      - name: Secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base:  ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Run security code scan
        uses: security-code-scan/security-code-scan-add-action@main
        continue-on-error: true

  build: 
    name: Build Solution
    runs-on: ubuntu-latest
    needs: [pre-flight-checks, code-formatting]
    
    strategy:
      matrix:
        configuration: [Debug, Release]
    
    steps:
      - name: Checkout code
        uses:  actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with: 
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path:  ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name:  Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ matrix.configuration }} --no-restore

      - name: Upload build artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with: 
          name: build-artifacts-${{ matrix.configuration }}
          path: |
            **/bin/${{ matrix.configuration }}/**
            **/obj/${{ matrix.configuration }}/**
          retention-days: 7

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version:  ${{ env.DOTNET_VERSION }}

      - name:  Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: Run unit tests
        run: |
          dotnet test ${{ env.SOLUTION_FILE }} \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger "trx;LogFileName=test-results.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --filter "Category=Unit|FullyQualifiedName! ~Integration"

      - name:  Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name:  Unit Test Results
          path: '**/test-results.trx'
          reporter: dotnet-trx

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-unit
          path: TestResults/**/coverage.cobertura.xml
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs:  build
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: YourStrong@Passw0rd
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses:  actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with: 
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Wait for SQL Server
        run: sleep 15

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: Run integration tests
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost,1433;Database=CoreXFitnessTestDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;"
        run: |
          dotnet test ${{ env. SOLUTION_FILE }} \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger "trx;LogFileName=integration-test-results.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --filter "Category=Integration"

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Test Results
          path: '**/integration-test-results.trx'
          reporter: dotnet-trx

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-integration
          path: TestResults/**/coverage.cobertura.xml
          retention-days: 7

  code-coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download unit test coverage
        uses: actions/download-artifact@v4
        with: 
          name: coverage-report-unit
          path: ./coverage/unit

      - name: Download integration test coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-integration
          path: ./coverage/integration

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate combined coverage report
        run: |
          reportgenerator \
            "-reports:./coverage/**/coverage.cobertura.xml" \
            "-targetdir: ./coverage/report" \
            "-reporttypes:Html;Cobertura;MarkdownSummary" \
            "-classfilters:-System.*;-Microsoft.*"

      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-combined
          path: ./coverage/report
          retention-days: 30

      - name: Code Coverage Summary
        run: cat ./coverage/report/Summary.md >> $GITHUB_STEP_SUMMARY

      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep -oP 'Line coverage: \K[0-9.]+' ./coverage/report/Summary.md | head -1)
          THRESHOLD=70.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          fi
          echo "Coverage $COVERAGE% meets threshold $THRESHOLD%"

  database-migration-check:
    name: Database Migration Validation
    runs-on: ubuntu-latest
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: YourStrong@Passw0rd
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup . NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name:  Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Wait for SQL Server
        run: sleep 15

      - name:  Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: Test migrations (up)
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost,1433;Database=CoreXFitnessMigrationTest;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;"
        run: |
          cd ./CoreXFitness.API  # Adjust to your API/Web project directory
          dotnet ef database update --verbose

      - name: Generate migration script
        run: |
          cd ./CoreXFitness.API
          dotnet ef migrations script --idempotent --output migration-script.sql

      - name: Upload migration script
        uses: actions/upload-artifact@v4
        with:
          name: migration-script
          path: ./CoreXFitness.API/migration-script.sql
          retention-days: 30

  api-contract-validation:
    name: API Contract Validation
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version:  ${{ env.DOTNET_VERSION }}

      - name:  Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build solution
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: Generate OpenAPI/Swagger spec
        run: |
          cd ./CoreXFitness.API
          dotnet run --no-build --configuration Release &
          APP_PID=$!
          sleep 10
          curl http://localhost:5000/swagger/v1/swagger.json -o swagger.json || true
          kill $APP_PID || true

      - name: Validate OpenAPI spec
        if: always()
        uses: char0n/swagger-editor-validate@v1
        with:
          definition-file: ./CoreXFitness. API/swagger.json
        continue-on-error: true

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [static-analysis, security-scanning, unit-tests, integration-tests, code-coverage, database-migration-check]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          if [ "${{ needs.static-analysis.result }}" != "success" ] || \
             [ "${{ needs.security-scanning.result }}" != "success" ] || \
             [ "${{ needs.unit-tests. result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.code-coverage.result }}" != "success" ] || \
             [ "${{ needs.database-migration-check.result }}" != "success" ]; then
            echo "Quality gate failed - one or more checks did not pass"
            exit 1
          fi
          echo "Quality gate passed - all checks successful"
